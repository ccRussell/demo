# OpenTsdb基本概念

##前言

在公司负责监控系统，其中监控数据的存储使用的是openTsdb，因此花费一些时间系统的学习了下openTsdb的概念以及存储和查询。在学习的过程中也积累了一些心得，因此想整理一下，希望对正在学习openTsdb的小伙伴有一些帮助。

## 一、概述

openTsdb是一个分布式的、可扩展的时间序列数据库，用官网的话说：

> The Scalable Time Series Database; Store and serve massive amounts of time series data without losing granularity.

它的特点是能够提供最高毫秒级别的时间序列数据的存储，能够长久的保存原始数据并且不丢失精度。它拥有很强大的数据写入能力，支持大并发的数据写入。由于底层构建与Hadoop和Hbase之上，因此拥有可以无限水平扩展的存储容量。

## 二、概念

openTsdb的一个典型的使用场景就是作为监控数据的存储介质。因此在讲解概念的时候会主要列举监控方面的例子。

###2.1 Time Series Data（时间序列数据）

在官网的介绍中，openTsdb就是一个时间序列数据库，也就是说openTsdb适合存储的数据应该是时间序列的数据。所谓的时间序列数据就是指带有时间属性的数据，这么说可能比较抽象，我们用监控数据进行说明。

假设你要监控某一台机器的cpu使用率，那我们希望采集的数据应该某个时间点的cpu的使用率。如果单单采集使用率而没有对应的时间戳，那这数据对我们来说是没有意义的。采集的数据应该类似于这样：

| 时间                | cpu使用率 |
| :------------------ | --------- |
| 2018-11-24 21:00:00 | 45%       |
| 2018-11-24 21:01:00 | 30%       |
| 2018-11-24 21:02:00 | 50%       |
| 2018-11-24 21:03:00 | 70%       |

上面这样一组数据就是所谓的时间序列数据，即数据点的值和时间是一一对应的。

###2.2 Metrics（指标）

在openTsdb中，所存储的每一条数据的值其实都属于某一个指标。以上述为例，45%只是一个冰冷的数字，因此我们在存储的时候需要告诉tsdb，这个数字代表的cpu使用率。而cpu使用率对于tsdb来说就是一个指标。你也可以将它理解为在数据库中存储的一组时间序列数据的标识。

###2.3 Tags（标签）

在Metric中讲到可以将其理解为一组时间序列数据的标识，但是这其实还是有一些缺陷。假设我有两台机器，hostA和hostB，我想对两台机器的cpu使用率进行监控，按照metric的定义，我应该建立两个metric，分别为hostA机器的cpu使用率，hostB机器的使用率。是不是感觉这样很冗余？因为在实际中我们可能会有成千上万台机器需要监控，难道我们要建立成千上万个metric？opentsdb中引入了tag的概念帮我们解决这个问题

我们仍然只建立一个cpu使用率的metric，但是为了区分到底是哪台机器的数据，我们可以在这个metric下打个标签告诉tsdb，这条数据是属于哪台机器的。tags其实就是一个键值对（tagK=tagV），用来更细粒度的对db中的数据进行标识。

openTsdb规定：一个metric下面最少需要一个tag，最多只能有8个tag

##三、总结

讲到这里，你会发现openTsdb通过timestamp、metric、tags这个三个概念已经可以完全定位到一条数据了，下面我们通过一个具体的监控场景来展示时间序列数据在openTsdb中是如何存储的。

假设我有两台机器：hostA和hostB；每台机器有两个核：core1和core2；我想要监控每个核的cpu使用率，按分钟粒度进行数据上报。所以采集到openTsdb中的数据应该类似这样：

| metric      | timestamp           | tag1       | tag2       | value |
| ----------- | ------------------- | ---------- | ---------- | ----- |
| sys.cpu.use | 2018-11-24 21:00:00 | host=hostA | core=core1 | 45%   |
| sys.cpu.use | 2018-11-24 21:00:00 | host=hostA | core=core2 | 40%   |
| sys.cpu.use | 2018-11-24 21:00:00 | host=hostB | core=core1 | 50%   |
| sys.cpu.use | 2018-11-24 21:00:00 | host=hostB | core=core2 | 25%   |

到这里相信大家已经对openTsdb中的基本概念有了一个大致的认识，下一节我会讲解如何安装openTsdb。

